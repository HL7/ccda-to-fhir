map "http://hl7.org/fhir/cda/mapping/ClinicalDocumentToFHIR" = "CDA Document to FHIR"

uses "http://hl7.org/fhir/cda/StructureDefinition/ClinicalDocument" alias ClinicalDocument as source
uses "http://hl7.org/fhir/cda/StructureDefinition/AssignedAuthor" alias AssignedAuthor as queried
uses "http://hl7.org/fhir/cda/StructureDefinition/AssignedEntity" alias AssignedEntity as queried
uses "http://hl7.org/fhir/cda/StructureDefinition/CustodianOrganization" alias CustodianOrganization as queried
uses "http://hl7.org/fhir/cda/StructureDefinition/Section" alias Section as queried
uses "http://hl7.org/fhir/cda/StructureDefinition/PatientRole" alias PatientRole as queried
uses "http://hl7.org/fhir/StructureDefinition/Bundle" alias Bundle as target
uses "http://hl7.org/fhir/StructureDefinition/Composition" alias Composition as produced
uses "http://hl7.org/fhir/StructureDefinition/Patient" alias Patient as produced
uses "http://hl7.org/fhir/StructureDefinition/Practitioner" alias Practitioner as produced
uses "http://hl7.org/fhir/StructureDefinition/Organization" alias Organization as produced

imports "http://hl7.org/fhir/cda/mapping/cdaToFhirTypes"
imports "http://hl7.org/fhir/cda/mapping/ccdaDocumentToFhir"

group ClinicalDocumentBundle(source source : ClinicalDocument, target target : Bundle) {
  source.id -> target.identifier;
  source -> target.type = 'document' "type";
  source ->  target.entry as e first,  e.resource = create('Composition') as composition then ClinicalDocumentComposition(source, composition, target) "composition";
}

group ClinicalDocumentComposition(source source : ClinicalDocument, target target : Composition, target bundle : Bundle) {
  source.templateId as template then TemplateID(template, target) "templateID";
  source.languageCode -> target.language;
  source.setId -> target.identifier "setID";
  source -> target.status = 'final' "status";
  source.code -> target.type;
  source.recordTarget as recordTarget ->  bundle.entry as e,  e.resource = create('Patient') as patientResource then {
    recordTarget.patientRole as patient -> target.subject = reference(patientResource) then ClinicalDocumentPatientRole(patient, patientResource, bundle) "subject";
    source.component as component then {
      component.structuredBody as body then {
        body.component as component then CCDASections(source, component, patientResource, target, bundle) "bodyComponent";
      } "body";
    };
  };
  source.componentOf as comp ->  bundle.entry as e,  e.resource = create('Encounter') as encounter then {
    comp.encompassingEncounter as srcEnc -> target.encounter = reference(encounter) then ClinicalDocumentEncounter(srcEnc, bundle, encounter) "srcEncounter";
  } "encompassingEncounter";
  source.effectiveTime -> target.date;
  source.author as srcAuthor ->  bundle.entry as e,  e.resource = create('Practitioner') as practitioner then {
    srcAuthor.assignedAuthor as assignedAuthor -> target.author = reference(practitioner) then ClinicalDocumentAuthorPractitioner(assignedAuthor, practitioner) "author";
  };
  source.title as t -> target.title;
  source.confidentialityCode -> target.confidentiality;
  source.legalAuthenticator as legalAuth ->  bundle.entry as e,  e.resource = create('Practitioner') as practitioner then {
    legalAuth -> target.attester as attester then {
      legalAuth -> attester.mode = 'legal' "mode";
      legalAuth.time -> attester.time;
      legalAuth.assignedEntity as entity -> attester.party = reference(practitioner) then ClinicalDocumentEntityPractitioner(entity, practitioner) "entity";
    } "attester";
  };
  source.authenticator as auth ->  bundle.entry as e,  e.resource = create('Practitioner') as practitioner then {
    auth -> target.attester as attester then {
      auth -> attester.mode = 'official' "mode";
      auth.time -> attester.time;
      auth.assignedEntity as entity -> attester.party = reference(practitioner) then ClinicalDocumentEntityPractitioner(entity, practitioner) "entity";
    } "attester";
  };
  source.custodian as custodian -> bundle.entry as e then {
    custodian.assignedCustodian as assignedCustodian -> e.resource = create('Organization') as organization then {
      assignedCustodian.representedCustodianOrganization as srcOrg -> target.custodian = reference(organization) then ClinicalDocumentOrganization(srcOrg, organization) "assignedCustodian";
    } "custodian";
  };
  source.documentationOf as docOf then {
    docOf.serviceEvent as serviceEvent -> target.event as event then {
      serviceEvent.code -> event.code "eventCode";
      serviceEvent.effectiveTime -> event.period "eventTime"; // performerType: for source.performer.typeCode ...
    };
  };
  source.relatedDocument as relatedDoc -> target.relatesTo as relates then {
    relatedDoc.typeCode -> relates.code;
    relatedDoc.parentDocument as parentDoc then {
      parentDoc.setId -> relates.targetIdentifier;
    } "parentDoc";
  };
}

group ClinicalDocumentSection(source source : Section, source patient : Patient, target target) {
  source.templateId as template then TemplateID(template, target) "templateID";
  source.title -> target.title;
  source.code -> target.code;
  source.text as cdaText -> target.text as fhirText then {
    cdaText -> fhirText.status = 'generated' "narrativestatus";
    cdaText as t -> fhirText.div = t "narrativeText";
  };
  source.section as srcSection -> target.section as tgtSection then ClinicalDocumentSection(srcSection, patient, tgtSection);
}

group ClinicalDocumentAuthorPractitioner(source source : AssignedAuthor, target target : Practitioner) {
  source.id -> target.identifier;
  source.addr -> target.address;
  source.telecom -> target.telecom;
  source.assignedPerson as person then {
    person.name -> target.name;
  };
}

group ClinicalDocumentEntityPractitioner(source source : AssignedEntity, target target : Practitioner) {
  source.id -> target.identifier;
  source.addr -> target.address;
  source.telecom -> target.telecom;
  source.assignedPerson as person then {
    person.name -> target.name;
  };
}

group ClinicalDocumentOrganization(source source : CustodianOrganization, target target : Organization) {
  source.id -> target.identifier;
  source.name -> target.name;
  source.telecom -> target.telecom;
  source.addr -> target.address;
}

group ClinicalDocumentPatientRole(source source : PatientRole, target target : Patient, target bundle : Bundle) {
  source.id -> target.identifier;
  source.addr -> target.address;
  source.telecom -> target.telecom;
  source.patient as patient then {
    patient.name -> target.name; // gender: for patient.administrativeGenderCode make target.gender
    patient.birthTime -> target.birthDate "birthDate";
    patient.deceasedInd as indicator where patient.deceasedTime.empty() -> target.deceased = create('boolean') as bool then boolean(indicator, bool) "deceasedBL";
    patient.deceasedTime -> target.deceased;
    patient.maritalStatusCode -> target.maritalStatus "maritalStatus";
    patient.languageCommunication as language -> target.communication as communication then {
      language.languageCode -> communication.language "communication"; // preference: for language.preferenceInd make communication.preferred
    } "language";
  };
  source.providerOrganization as org ->  bundle.entry as e,  e.resource = create('Organization') as organization then {
    org -> target.managingOrganization = reference(organization) "reference";
    org.id -> organization.identifier;
    org.name -> organization.name;
    org.telecom -> organization.telecom;
    org.addr -> organization.address;
  } "organization";
}

group ClinicalDocumentEncounter(source source : EncompassingEncounter, target bundle : Bundle, target target : Encounter) {
  source.id -> target.identifier;
  source.code -> target.type;
  source.effectiveTime -> target.period;
  source where admissionReferralSourceCode.exists() or dischargeDispositionCode.exists() -> target.hospitalization as hosp then {
    source.admissionReferralSourceCode -> hosp.admitSource "adminReferral";
    source.dischargeDispositionCode -> hosp.dischargeDisposition "discDisposition";
  } "hospitalization";
  source.encounterParticipant as srcPart -> target.participant as tgtPart then {
    srcPart.typeCode as code -> tgtPart.type = cc('http://terminology.hl7.org/CodeSystem/v3-ParticipationType', code);
    srcPart.time -> tgtPart.period;
    srcPart.assignedEntity as entity ->  bundle.entry as e,  e.resource = create('Practitioner') as practitioner then {
      entity -> tgtPart.individual = reference(practitioner) then ClinicalDocumentEntityPractitioner(entity, practitioner) "entry";
    } "entity";
  } "participant";
  source.location as srcLocation then {
    srcLocation.healthCareFacility as facility ->  bundle.entry as e,  e.resource = create('Location') as location then {
      facility ->  target.location as tgtLocation,  tgtLocation.location = reference(location) then ClinicalDocumentLocation(facility, bundle, location) "facLocation";
    } "facility";
  };
}

group ClinicalDocumentLocation(source source : HealthCareFacility, target bundle : Bundle, target target : Location) {
  source.id -> target.identifier;
  source.code -> target.type;
  source.location as location then {
 // place names are usually stored with no parts    location.name as srcName -> target.name = cast(srcName, 'string');
    location.addr -> target.address;
    location.serviceProviderOrganization as srcOrg ->  bundle.entry as e,  e.resource = create('Organization') as organization then {
      srcOrg -> target.managingOrganization = reference(organization) then ClinicalDocumentOrganization(srcOrg, organization) "organization";
    } "org";
  }; // place names are usually stored with no parts
}

