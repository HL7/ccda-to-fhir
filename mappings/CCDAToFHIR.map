map "http://hl7.org/fhir/cda/mapping/ccdaDocumentToFhir" = "C-CDA Document from CDA to FHIR"

uses "http://hl7.org/fhir/cda/StructureDefinition/ClinicalDocument" alias ClinicalDocument as source
uses "http://hl7.org/fhir/StructureDefinition/Bundle" alias Bundle as target
uses "http://hl7.org/fhir/StructureDefinition/Composition" alias Composition as produced
uses "http://hl7.org/fhir/StructureDefinition/Patient" alias Patient as source
uses "http://hl7.org/fhir/cda/StructureDefinition/Act" alias Act as source
uses "http://hl7.org/fhir/StructureDefinition/AllergyIntolerance" alias AllergyIntolerance as source

imports "http://hl7.org/fhir/cda/mapping/cdaAllergyIntolerance"
imports "http://hl7.org/fhir/cda/mapping/ClinicalDocumentToFHIR"

group CCDADocument(source source : ClinicalDocument) {
  source -> create('Bundle') as target then ClinicalDocumentBundle(source, target) "start";
}

group CCDASections(source source : ClinicalDocument, source component, source patient : Patient, target target : Composition, target bundle : Bundle) {
  component.section as srcSection where code.code = '48765-2' -> target.section as tgtSection then AllergySection(srcSection, patient, bundle, tgtSection) "allergySection";
  component.section as srcSection where code.code != '48765-2' -> target.section as tgtSection then ClinicalDocumentSection(srcSection, patient, tgtSection);
}

